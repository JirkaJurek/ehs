<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <style>
      body {
        width: 1230px;
        margin: 20px auto;
        font-family: Georgia;
      }

      h1 {
        margin: 0;
      }

      a {
        color: blue;
      }

      #editor {
        width: 600px;
        height: 775px;
        margin-right: 20px;
        display: inline-block;
      }

      iframe {
        border: 1px solid black;
        width: 90%;
        height: 550px;
      }
    </style>
  </head>
  width: 100%; height: 550px;

  <body>
    <h1>PDF</h1>
    <iframe></iframe>
    <div id="editor"></div>
    <script src="./pdfbundle.js"></script>
    <script>
      const columns = [
        "name",
        "serNumber",
        "invNumber",
        "code",
        "count",
        "description"
      ];
      const columnWidth = {
        name: 185,
        serNumber: 70,
        invNumber: 70,
        code: 70,
        count: 35,
        description: 120
      };
      const defaultMargin = {
        top: 30,
        bottom: 10,
        left: 30,
        right: 30
      };
      const tableMargin = 6;
      const getHeightOfString = (text, width, fontSize = 10) => {
        PDFDocumentExport.fontSize(fontSize);
        return (
          tableMargin +
          PDFDocumentExport.heightOfString(text, {
            width,
            align: "center",
            fontSize: 16
          })
        );
      };
      const getHeader = () => `doc
              .fontSize(18)
              .text(
                "Seznam naradi",
                {
                  align: "center"
                },
                20
              )
              .fontSize(14)
              .text("Sklad: 019 - Ponk c.19")
              .text("Odpovedny zamestnanec: Lenka Rosecká")`;
      const getTexts = (row, y) => {
        result = "";
        x = defaultMargin.left;
        for (col of columns) {
          if (row[col]) {
            result += `
                  doc.text("${row[col]}", ${x + tableMargin / 2}, ${y +
              tableMargin / 2}, {width: ${columnWidth[col] -
              tableMargin}, align: "center"})
                `;
          }
          x += columnWidth[col];
        }
        return result;
      };

      const createTable = ({ start, stop, lineHeight = 18, rowsData }) => {
        let result = "";
        currentLineY = start;
        for (row of rowsData) {
          let maxHeight = 0;
          const rowKeys = Object.keys(row);
          for (key of rowKeys) {
            maxHeight = Math.max(
              maxHeight,
              getHeightOfString(row[key], columnWidth[key])
            );
          }
          if (currentLineY + maxHeight >= stop) {
            currentLineY = 90;
            result += `
                doc.stroke()
                doc.addPage()
                ${getHeader()}
                  `;
          }
          result += `doc.lineJoin('miter')`;
          x = defaultMargin.left;
          for (col of columns) {
            result += `.rect(${x}, ${currentLineY}, ${
              columnWidth[col]
            }, ${maxHeight})`;
            x += columnWidth[col];
          }
          result += `

                doc.fontSize(10)
                ${getTexts(row, currentLineY)}
                `;
          currentLineY += maxHeight;
        }

        const count = (stop - currentLineY) / lineHeight;

        for (let i = 0; i < count; i++) {
          result += `;doc.lineJoin('miter')`;
          x = defaultMargin.left;
          for (col of columns) {
            result += `.rect(${x}, ${currentLineY}, ${
              columnWidth[col]
            }, ${lineHeight})`;
            x += columnWidth[col];
          }
          currentLineY += lineHeight;
        }

        return result;
      };
      /**
       * šířka stránky je 610
       */
      setTimeout(
        () =>
          editor.setValue(`
          // create a document and pipe to a blob
          var doc = new PDFDocument({margins : {
              top: ${defaultMargin.top},
              bottom: ${defaultMargin.bottom},
              left: ${defaultMargin.left},
              right: ${defaultMargin.right}
            }, bufferPages: true});
            var stream = doc.pipe(blobStream());

            ${getHeader()}
              doc.moveDown()
              .text("Vydal:")
              .moveDown()
              .text("Prevzal:")
              .moveUp()
              .moveUp()
              .moveUp()
              .text("dne:", 305)
              .moveDown()
              .text("dne:");

                ${createTable({
                  start: 155,
                  stop: 740,
                  rowsData: [
                    {
                      name: "Nazev stroje",
                      serNumber: "seri. cislo",
                      invNumber: "inv. cislo",
                      code: "kod",
                      count: "pocet",
                      description: "Poznámka"
                    },
                    {
                      name: "Monitor SAMSUNG LS24D330",
                      serNumber: "WV2ZZZ7HZHX028868",
                      invNumber: "371000002",
                      code: "HD TSH P+H",
                      count: "999"
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka",
                      serNumber: "2015/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka",
                      serNumber: "2015/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka",
                      serNumber: "2015/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka",
                      serNumber: "2015/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka",
                      serNumber: "2015/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka",
                      serNumber: "2015/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka",
                      serNumber: "2015/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    },
                    {
                      name: "Chladnicka ACW-LP 12 AL OR SL (15/27) EURO COLD",
                      serNumber: "2015/018860/005",
                      count: 1
                    }
                  ]
                })}
         doc.stroke()
         doc.x = 30
         
                const range = doc.bufferedPageRange(); // => { start: 0, count: 2 }
              for (i = range.start, end = range.start + range.count, range.start <= end; i < end; i++) {
               doc.switchToPage(i);
               doc.fontSize(10)
              .text("Stránka " + (i + 1 ) + "/" + range.count, {
                  align: "center"
                }, 760)
              }

      doc.end();
      stream.on('finish', function() {
        iframe.src = stream.toBlobURL('application/pdf');
      });
        `),
        100
      );
    </script>
    Protokol o revizích a kontrolách elektrického spotřebiče, elektrického
    ručního nářadí nebo prodlužovacího přívodu provedených dle ČSN 331600 ed.
    2:2009
  </body>
</html>
